/*
 menu v0.1.0 - (c) Mark Stubbs 2015, freely distributable under the terms of the MIT license.

*/
Menu.nextAvailableId=0;Menu.nextAvailableRadioGroupId=0;Menu.shortcuts=[];
function Menu(A,M){function v(a,b,c){a&&(b=Array.isArray(b)?b:[b],"PREPEND"===c&&b.reverse(),b.forEach(function(b){var d;d=b?"string"===typeof b?{text:b}:"object"===typeof b?b:void 0:{text:""};var e=document.createElement("li");e.id=d.id||"";e.textContent=d.text||"";d.disabled&&e.setAttribute("aria-disabled","true");d.checked&&e.setAttribute("aria-checked","true");d.role&&e.setAttribute("role",d.role);N.forEach(function(a){d[a]&&e.setAttribute("data-"+a,d[a])});var h;c=c||"AFTER";switch(c){case "APPEND":if(0===
a.children.length)b=document.createElement("ul"),b.setAttribute("role","menu"),a.appendChild(b);else if(2<x(a))for(h=a.children[0].querySelectorAll("."+f.prefix+"-placeholder"),b=0;b<h.length;b++)a.children[0].removeChild(h[b]);a.children[0].appendChild(e);break;case "PREPEND":if(0===a.children.length)b=document.createElement("ul"),b.setAttribute("role","menu"),a.appendChild(b);else if(2<x(a))for(h=a.children[0].querySelectorAll("."+f.prefix+"-placeholder"),b=0;b<h.length;b++)a.children[0].removeChild(h[b]);
a.children[0].insertBefore(e,a.children[0].firstChild);break;case "BEFORE":a.parentNode.insertBefore(e,a);break;case "AFTER":a.parentNode.insertBefore(e,a.nextSibling),a=e}d.items&&(b=document.createElement("ul"),b.setAttribute("role","menu"),h=B(d.placeholder),b.appendChild(h),e.appendChild(b),v(h,d.items,"AFTER"),(3>x(h)||1<b.children.length)&&b.removeChild(h));y(e);d.className&&e.classList.add(d.className)}))}function y(a){function b(a){return a.id!==this.id&&a.key===this.key&&Utils.areEqual(a.modifiers,
this.modifiers)}a.className="";if(a.textContent){var c=a.getAttribute("role");c||(a.setAttribute("role","menuitem"),c="menuitem");if(!a.id){var g=a.firstChild.textContent;a.id=C((g||"").trim())}a.parentNode!==d&&a.children.length&&(a.classList.add(f.prefix+"-submenu"),a.children[0].children.length||a.children[0].appendChild(B(a.getAttribute("data-placeholder"))));"menuitemradio"!==c||a.hasAttribute("name")||(D&&(++Menu.nextAvailableRadioGroupId,D=!1),a.setAttribute("name",f.prefix+"-group-"+Menu.nextAvailableRadioGroupId));
if(a.getAttribute("data-icon")&&(a.classList.add(f.prefix+"-icon"),(c=a.getAttribute("data-icon").match(/^(.*?)\((.*?)\)$/))&&3===c.length))switch(c[1]){case "class":a.classList.add(c[2])}a.getAttribute("data-align")&&a.classList.add(f.prefix+"-align-right");if(a.getAttribute("data-shortcut"))if(q.show){for(var g=a.getAttribute("data-shortcut").toLowerCase().split(/\W+/),c=g[g.length-1],e=O(c),h={menu:r,id:a.id,key:e,modifiers:{c:!1,a:!1,s:!1,m:!1}},e=0;e<g.length-1;e++){var k=g[e].charAt(0);"undefined"!==
typeof h.modifiers[k]&&(h.modifiers[k]=!0)}if(g=Menu.shortcuts.find(b,h))console.warn("Ignored attempt to reassign shortcut",a.getAttribute("data-shortcut"),"to",a.id,"- already assigned to",g.id);else{Menu.shortcuts.push(h);var p=q.order.split(""),m=[];Object.keys(h.modifiers).forEach(function(a){h.modifiers[a]&&(m[p.indexOf(a)]=q.keys[a])});m.push(c.toUpperCase());a.setAttribute("data-shortcut-display",m.filter(function(a){return a}).join(q.separator))}}else a.setAttribute("data-shortcut-display",
"")}else a.setAttribute("role","separator"),D=!0}function C(a){return f.prefix+(1<r?r:"")+"-item-"+(a?a.replace(/[^\w\s]/g,"").replace(/\s+/g,"-").toLowerCase():++C.iNextId)}function p(a,b,c){for(var g=b;5>g;++g)for(var d=document.querySelectorAll("."+f.prefix+"-open-"+g),k=0;k<d.length;++k)d[k].classList.remove(f.prefix+"-open-"+g);if(a.children.length&&(a.children[0].classList.add(f.prefix+"-open-"+b),h.dispatchEvent("opened",a.id),c)){for(a=a.children[0].children[0];a&&("separator"===a.getAttribute("role")||
"true"===a.getAttribute("aria-disabled"));)a=a.nextElementSibling;a&&(a.classList.add(f.prefix+"-active"),h.dispatchEvent("enter",a.id),e=a)}}function E(a){a.classList.remove(f.prefix+"-active");a=a.querySelectorAll("."+f.prefix+"-active");for(var b=0;b<a.length;b++)a[b].classList.remove(f.prefix+"-active")}function B(a){var b=document.createElement("li");b.className=f.prefix+"-placeholder";b.textContent=a||"No items";b.setAttribute("aria-disabled","true");return b}function x(a){for(var b=1;a.parentNode&&
a.parentNode!==d;)a=a.parentNode,++b;return b}function k(a){a=a||null;var b,c=document.querySelectorAll("."+f.prefix+"-focus");for(b=0;b<c.length;b++){var g=c[b];if(!a||a!==g){var d=g.querySelectorAll("."+f.prefix+"-active");for(b=0;b<d.length;b++)d[b].classList.remove(f.prefix+"-active");d=g.querySelectorAll("."+f.prefix+"-open-1");for(b=0;b<d.length;b++)d[b].classList.remove(f.prefix+"-open-1");g.classList.remove(f.prefix+"-focus")}}e&&a!==e&&h.dispatchEvent("leave",e.id);e=a}function H(a){var b,
c=a.keyCode||a.which;"undefined"===typeof a.metaKey&&(a.metaKey=!1);if(b=Menu.shortcuts.find(P,{menu:r,key:c,modifiers:{c:a.ctrlKey,a:a.altKey,s:a.shiftKey,m:a.metaKey}})){var g=document.getElementById(b.id);g&&"true"!==g.getAttribute("aria-disabled")&&0===g.children.length&&(b=g.getAttribute("role"),"menuitemcheckbox"===b?z(g):"menuitemradio"===b&&w(g),g.classList.add(f.prefix+"-active"),h.dispatchEvent("click",g.id),setTimeout(function(){g.classList.remove(f.prefix+"-active")},f.menuActiveDuration),
a.stopPropagation(),a.preventDefault())}if(f.hotkey&&f.hotkey.modifiers&&c===f.hotkey.keycode&&a.altKey===f.hotkey.modifiers.a&&a.shiftKey===f.hotkey.modifiers.s&&a.ctrlKey===f.hotkey.modifiers.c&&a.metaKey===f.hotkey.modifiers.m){var l=document.querySelectorAll("."+f.prefix+"-active");for(b=0;b<l.length;b++)l[b].classList.remove(f.prefix+"-active");if(e)k();else if(d.children){d.classList.add(f.prefix+"-focus");for(b=0;b<d.children.length;b++)if(l=d.children[b],"true"!==l.getAttribute("aria-disabled")){l.classList.add(f.prefix+
"-active");p(l,1);e=l;break}p(d.children[0],1);e=d.children[0]}a.stopPropagation();a.preventDefault()}if(d.classList.contains(f.prefix+"-focus"))switch(c){case 13:case 32:case 33:case 34:case 37:case 38:case 39:case 40:Q(c);a.stopPropagation();a.preventDefault();break;case 27:k(),a.stopPropagation(),a.preventDefault()}}function P(a){return a.menu===this.menu&&a.key===this.key&&Utils.areEqual(a.modifiers,this.modifiers)}function Q(a){function b(a){for(;c&&("separator"===c.getAttribute("role")||"true"===
c.getAttribute("aria-disabled"));)c=a?c.previousElementSibling:c.nextElementSibling;c&&c!==e&&(e.parentNode!==d&&e.classList.remove(f.prefix+"-active"),c.classList.add(f.prefix+"-active"),h.dispatchEvent("enter",c.id),e=c)}var c,g=0,l,n=d.querySelector("ul.menu-top.menu-focus > li."+f.prefix+"-active");if(n){var m=e.parentNode!==d&&"right"===n.getAttribute("data-align");m&&(37==a?a=39:39==a&&(a=37));switch(a){case 13:case 32:e&&(0===e.children.length?(g=e.getAttribute("role"),"menuitemcheckbox"===
g?z(e):"menuitemradio"===g&&w(e),h.dispatchEvent("click",e.id),k()):p(e,F(e),!0));break;case 37:if(2<F(e))e.parentNode.className="",E(e),e=e.parentNode.parentNode;else{a=I();c=n;l=a.indexOf(n);do m?++l>=a.length&&(l=0,++g):0>--l&&(l=a.length-1,++g),c=a[l];while("true"===c.getAttribute("aria-disabled")&&3>g);n!==c&&(E(n),c.classList.add(f.prefix+"-active"),h.dispatchEvent("enter",c.id),p(c,1),e=c)}break;case 39:if(e.parentNode!==d&&e.children.length)p(e,F(e),!0);else{a=I();c=n;l=a.indexOf(n);do m?
0>--l&&(l=a.length-1,++g):++l>=a.length&&(l=0,++g),c=a[l];while("true"===c.getAttribute("aria-disabled")&&3>g);n!==c&&(E(n),c.classList.add(f.prefix+"-active"),h.dispatchEvent("enter",c.id),p(c,1),e=c)}break;case 38:c=e.parentNode===d&&n.children.length?n.children[0].children[n.children[0].children.length-1]:e.previousElementSibling;b(!0);break;case 40:e.parentNode===d&&n.children.length?(e.children.length&&!e.children[0].classList.contains(f.prefix+"-open-1")&&p(e,1),c=n.children[0].children[0]):
c=e.nextElementSibling;b();break;case 33:if(g=e.parentNode===d?e.children[0]:e.parentNode)c=g.children[0],b();break;case 34:if(g=e.parentNode===d?e.children[0]:e.parentNode)c=g.children[g.children.length-1],b(!0)}}}function I(){for(var a=[],b=0,c=d.children.length;b<c;b++)a.push(d.children[b]);a.sort(function(a,b){return a.offsetLeft-b.offsetLeft});return a}function O(a){if(!a)return 0;if(1==a.length)return a.toUpperCase().charCodeAt(0);if(a=/^f(\d+)$/.exec(a))return 111+Number(a[1])}function F(a){for(var b=
1;a!==d;)"UL"===a.nodeName&&++b,a=a.parentNode;return b}function z(a){"true"===a.getAttribute("aria-checked")?a.removeAttribute("aria-checked"):a.setAttribute("aria-checked","true")}function w(a){for(var b=a.parentNode.querySelectorAll('li[name="'+a.getAttribute("name")+'"][aria-checked="true"]'),c=0;c<b.length;c++)b[c].removeAttribute("aria-checked");a.setAttribute("aria-checked","true")}var h=this,r=null,d,m={},J,e,t=!1,D=!1,K=!1,f={prefix:"menu",popupDelay:300,menuActiveDuration:120,hotkey:null};
document.documentElement.classList.add(platform.os.family.toLowerCase().replace(/\W+/g,"-"));var N=["icon","align","placeholder","shortcut"],q={show:!1,separator:"",order:"scam",keys:{s:"",c:"",a:"",m:""}};switch(platform.os.family.toLowerCase()){case "windows":case "windows xp":case "windows nt":case "windows server 2008 r2 / 7":case "windows server 2008 r2 / 7 x64":case "windows server 2008 / vista":q={show:!0,separator:"+",order:"mcas",keys:{s:"Shift",c:"Ctrl",a:"Alt",m:"Win"}};break;case "os x":q=
{show:!0,separator:"",order:"casm",keys:{s:"\u21e7",c:"\u2303",a:"\u2325",m:"\u2318"}}}if(A)if(d=document.getElementById(A))if("UL"!==d.nodeName)d=null,console.error("Root menu element must be a <ul>");else{r=++Menu.nextAvailableId;Utils.merge(f,M);var u=d.getElementsByTagName("ul"),L=d.getElementsByTagName("li");document.attachEvent?document.attachEvent("onkeydown",H):document.addEventListener("keydown",H);d.classList.add(f.prefix+"-top");d.setAttribute("role","menubar");d.style.zIndex+=50-r;for(var G=
0;G<u.length;++G)u[G].setAttribute("role","menu");for(u=0;u<L.length;++u)y(L[u]);d.style.display="block";d.addEventListener("mouseover",function(a){clearTimeout(J);if("true"!==a.target.getAttribute("aria-disabled")&&"separator"!==a.target.getAttribute("role")&&d.classList.contains(f.prefix+"-focus")&&"LI"===a.target.nodeName){h.dispatchEvent("enter",a.target.id);e=a.target;for(var b=d.querySelectorAll("."+f.prefix+"-active"),c=0;c<b.length;c++)b[c].classList.remove(f.prefix+"-active");for(var g=1,
b=a.target;b!==d;){switch(b.nodeName){case "UL":++g;break;case "LI":b.classList.add(f.prefix+"-active")}b=b.parentNode}q.show&&a.target.parentNode!==d&&0!==f.popupDelay?J=setTimeout(function(){p(a.target,g)},f.popupDelay):p(a.target,g)}a.stopPropagation()});d.addEventListener("mouseout",function(a){d.classList.contains(f.prefix+"-focus")&&"LI"===a.target.nodeName&&(a.target.children.length||a.target.classList.remove(f.prefix+"-active"),"true"!==a.target.getAttribute("aria-disabled")&&"separator"!==
a.target.getAttribute("role")&&h.dispatchEvent("leave",a.target.id));a.stopPropagation()});d.addEventListener("touchstart",function(a){a.stopPropagation();t=!0;var b=a.target;f.popupDelay=0;if(b===d)k();else if(b.parentNode===d&&k(),"true"!==b.getAttribute("aria-disabled")){var c=!!b.children.length;b.parentNode===d?(d.classList.toggle(f.prefix+"-focus"),b.classList.toggle(f.prefix+"-active"),b.classList.contains(f.prefix+"-active")?(k(d),e=b,h.dispatchEvent("enter",b.id),c||h.dispatchEvent("click",
b.id),p(a.target,1),c||setTimeout(function(){k()},f.menuActiveDuration)):(c||h.dispatchEvent("click",b.id),k())):"separator"===b.getAttribute("role")||c||(a=b.getAttribute("role"),"menuitemcheckbox"===a?z(b):"menuitemradio"===a&&w(b),h.dispatchEvent("click",b.id),k())}});d.addEventListener("click",function(a){a.stopPropagation();a.preventDefault();if(t)t=!1;else{var b=a.target;if(b===d)k();else if("true"!==b.getAttribute("aria-disabled")){var c=!!b.children.length;b.parentNode===d?(K?K=!1:(d.classList.toggle(f.prefix+
"-focus"),b.classList.toggle(f.prefix+"-active")),b.classList.contains(f.prefix+"-active")?(k(d),e=b,h.dispatchEvent("enter",b.id),c||h.dispatchEvent("click",b.id),p(a.target,1),c||setTimeout(function(){k()},f.menuActiveDuration)):(c||h.dispatchEvent("click",b.id),k())):"separator"===b.getAttribute("role")||c||(a=b.getAttribute("role"),"menuitemcheckbox"===a?z(b):"menuitemradio"===a&&w(b),h.dispatchEvent("click",b.id),k())}}});document.addEventListener("click",function(){t?t=!1:k()});document.addEventListener("touchstart",
function(){t=!0;k()});h.insertAfter=function(a,b){var c,g;a?c=document.getElementById(a):d.children.length?c=d.children[d.children.length-1]:(g=document.createElement("li"),d.appendChild(g),c=g);c&&(v(c,b),g&&d.removeChild(g))};h.insertBefore=function(a,b){var c,g;a?c=document.getElementById(a):d.children.length?c=d.children[0]:(g=document.createElement("li"),d.appendChild(g),c=g);c&&(v(c,b,"BEFORE"),g&&d.removeChild(g))};h.append=function(a,b){var c;a&&(c=document.getElementById(a));c&&v(c,b,"APPEND")};
h.prepend=function(a,b){var c;a&&(c=document.getElementById(a));c&&v(c,b,"PREPEND")};h.replace=function(a,b){h.clear(a);h.append(a,b)};h.remove=function(a){(a=document.getElementById(a))&&a.parentNode.removeChild(a)};h.set=function(a,b){var c=document.getElementById(a);c&&"object"===typeof b&&(Object.keys(b).forEach(function(a){switch(a){case "text":c.textContent=b.text;break;case "className":c.classList.add(b.className);break;case "disabled":b.disabled?c.setAttribute("aria-disabled","true"):c.removeAttribute("aria-disabled");
break;case "role":case "name":c.setAttribute(a,b[a]);break;case "checked":a=c.getAttribute("role");b.checked?"menuitemcheckbox"===a?c.setAttribute("aria-checked","true"):"menuitemradio"===a&&w(c):c.removeAttribute("aria-checked");break;case "align":case "icon":case "placeholder":case "shortcut":c.setAttribute("data-"+a,b[a])}}),y(c))};h.get=function(a){var b=document.getElementById(a);if(!b)return{};a={align:b.getAttribute("data-align")||"left",className:b.className,disabled:b.getAttribute("aria-disabled")||
!1,icon:b.getAttribute("data-icon")||null,id:a,menu:r,placeholder:b.getAttribute("data-placeholder")||null,shortcut:b.getAttribute("data-shortcut")||null,role:b.getAttribute("role")||null};if("menuitemcheckbox"===a.role||"menuitemradio"===a.role)a.checked=b.getAttribute("aria-checked")||!1;"menuitemradio"===a.role&&(a.name=b.getAttribute("name")||null);return a};h.getGroupChecked=function(a){return(a=d.querySelector('li[name="'+a+'"][aria-checked="true"]'))?a.id:null};h.clear=function(a,b){if(a){var c=
document.getElementById(a);if(c&&c.children.length){var d=c.children[0];if(b)c.removeChild(d);else{for(;d.firstChild;)d.removeChild(d.firstChild);d.appendChild(B(c.getAttribute("data-placeholder")))}y(c)}}};h.addEventListener=function(a,b){m[a]=m[a]||[];-1===m[a].indexOf(b)&&m[a].push(b);return b};h.removeEventListener=function(a,b){if("undefined"!==typeof m[a]){var c=m[a].indexOf(b);-1!==c&&m[a].splice(c,1)}};h.dispatchEvent=function(a,b){var c;try{c=new CustomEvent(a,{detail:b})}catch(d){c=document.createEvent("CustomEvent"),
c.initCustomEvent(a,!1,!1,b)}if("undefined"!==typeof m[c.type])for(var e=0;e<m[c.type].length;e++)m[c.type][e].call(this,c)};C.iNextId=0;h.addEventListener("opened",function(a){if((a=document.getElementById(a.detail))&&"LI"===a.nodeName&&a.children.length){for(var b=!1,c=a;c;){if("LI"===c.nodeName&&"right"===c.getAttribute("data-align")){b=!0;break}c=c.parentNode}2<x(a)&&(a.children[0].style.left=(b?"-"+(a.children[0].clientWidth-4):a.clientWidth-4)+"px")}})}else console.error("Cannot find root menu with id "+
A);else console.error("Missing menu id")};
