/*
 menu v0.1.0 - (c) Mark Stubbs 2015, freely distributable under the terms of the MIT license.

*/
Menu.nextAvailableId=0;Menu.nextAvailableRadioGroupId=0;Menu.shortcuts=[];
function Menu(D,O){function x(a,b,c){a&&(b=Array.isArray(b)?b:[b],"PREPEND"===c&&b.reverse(),b.forEach(function(b){var d;d=b?"string"===typeof b?{text:b}:"object"===typeof b?b:void 0:{text:""};var e=document.createElement("li");e.id=d.id||"";e.textContent=d.text||"";d.disabled&&e.setAttribute("aria-disabled","true");d.checked&&e.setAttribute("aria-checked","true");d.role&&e.setAttribute("role",d.role);P.forEach(function(a){d[a]&&e.setAttribute("data-"+a,d[a])});var g;c=c||"AFTER";switch(c){case "APPEND":if(0===
a.children.length)b=document.createElement("ul"),b.setAttribute("role","menu"),a.appendChild(b);else if(2<A(a))for(g=a.children[0].querySelectorAll("."+f.prefix+"-placeholder"),b=0;b<g.length;b++)a.children[0].removeChild(g[b]);a.children[0].appendChild(e);break;case "PREPEND":if(0===a.children.length)b=document.createElement("ul"),b.setAttribute("role","menu"),a.appendChild(b);else if(2<A(a))for(g=a.children[0].querySelectorAll("."+f.prefix+"-placeholder"),b=0;b<g.length;b++)a.children[0].removeChild(g[b]);
a.children[0].insertBefore(e,a.children[0].firstChild);break;case "BEFORE":a.parentNode.insertBefore(e,a);break;case "AFTER":a.parentNode.insertBefore(e,a.nextSibling),a=e}d.items&&(b=document.createElement("ul"),b.setAttribute("role","menu"),g=E(d.placeholder),b.appendChild(g),e.appendChild(b),x(g,d.items,"AFTER"),(3>A(g)||1<b.children.length)&&b.removeChild(g));y(e);d.className&&e.classList.add(d.className)}))}function y(a){function b(a){return a.id!==this.id&&a.key===this.key&&Utils.areEqual(a.modifiers,
this.modifiers)}a.className="";if(a.textContent){var c=a.getAttribute("role");if(!a.id){var h=a.firstChild.textContent;a.id=F((h||"").trim())}a.parentNode!==d&&a.children.length&&(a.classList.add(f.prefix+"-submenu"),a.setAttribute("aria-haspopup","true"),a.children[0].children.length||a.children[0].appendChild(E(a.getAttribute("data-placeholder"))));c||(a.setAttribute("role","menuitem"),c="menuitem");"menuitemradio"!==c||a.hasAttribute("name")||(G&&(++Menu.nextAvailableRadioGroupId,G=!1),a.setAttribute("name",
f.prefix+"-group-"+Menu.nextAvailableRadioGroupId));if(a.getAttribute("data-icon")&&(a.classList.add(f.prefix+"-icon"),(c=a.getAttribute("data-icon").match(/^(.*?)\((.*?)\)$/))&&3===c.length))switch(c[1]){case "class":a.classList.add(c[2])}a.getAttribute("data-align")&&a.classList.add(f.prefix+"-align-right");if(a.getAttribute("data-shortcut"))if(r.show){for(var h=a.getAttribute("data-shortcut").toLowerCase().split(/\W+/),c=h[h.length-1],e=Q(c),g={menu:t,id:a.id,key:e,modifiers:{c:!1,a:!1,s:!1,m:!1}},
e=0;e<h.length-1;e++){var k=h[e].charAt(0);"undefined"!==typeof g.modifiers[k]&&(g.modifiers[k]=!0)}if(h=Menu.shortcuts.find(b,g))console.warn("Ignored attempt to reassign shortcut",a.getAttribute("data-shortcut"),"to",a.id,"- already assigned to",h.id);else{Menu.shortcuts.push(g);var p=r.order.split(""),m=[];Object.keys(g.modifiers).forEach(function(a){g.modifiers[a]&&(m[p.indexOf(a)]=r.keys[a])});m.push(c.toUpperCase());a.setAttribute("data-shortcut-display",m.filter(function(a){return a}).join(r.separator))}}else a.setAttribute("data-shortcut-display",
"")}else a.setAttribute("role","separator"),G=!0}function F(a){return f.prefix+(1<t?t:"")+"-item-"+(a?a.replace(/[^\w\s]/g,"").replace(/\s+/g,"-").toLowerCase():++F.iNextId)}function p(a,b,c){for(var h=b;5>h;++h)for(var d=document.querySelectorAll("."+f.prefix+"-open-"+h),k=0;k<d.length;++k)d[k].classList.remove(f.prefix+"-open-"+h);if(a.children.length&&(a.children[0].classList.add(f.prefix+"-open-"+b),g.dispatchEvent("opened",a.id),c)){for(a=a.children[0].children[0];a&&("separator"===a.getAttribute("role")||
"true"===a.getAttribute("aria-disabled"));)a=a.nextElementSibling;a&&(a.classList.add(f.prefix+"-active"),g.dispatchEvent("enter",a.id),e=a)}}function H(a){a.classList.remove(f.prefix+"-active");for(var b=a.querySelectorAll("."+f.prefix+"-active"),c=0;c<b.length;c++)b[c].classList.remove(f.prefix+"-active");g.dispatchEvent("leave",a.id)}function E(a){var b=document.createElement("li");b.className=f.prefix+"-placeholder";b.textContent=a||f.defaultPlaceholder;b.setAttribute("aria-disabled","true");
return b}function A(a){for(var b=1;a.parentNode&&a.parentNode!==d;)a=a.parentNode,++b;return b}function k(a){a=a||null;var b,c=document.querySelectorAll("."+f.prefix+"-focus");for(b=0;b<c.length;b++){var h=c[b];if(!a||a!==h){var d=h.querySelectorAll("."+f.prefix+"-active");for(b=0;b<d.length;b++)d[b].classList.remove(f.prefix+"-active");d=h.querySelectorAll("."+f.prefix+"-open-1");for(b=0;b<d.length;b++)d[b].classList.remove(f.prefix+"-open-1");h.classList.remove(f.prefix+"-focus")}}e&&a!==e&&g.dispatchEvent("leave",
e.id);e=a}function J(a){var b,c=a.keyCode||a.which;"undefined"===typeof a.metaKey&&(a.metaKey=!1);if(b=Menu.shortcuts.find(R,{menu:t,key:c,modifiers:{c:a.ctrlKey,a:a.altKey,s:a.shiftKey,m:a.metaKey}})){var h=document.getElementById(b.id);h&&"true"!==h.getAttribute("aria-disabled")&&0===h.children.length&&(b=h.getAttribute("role"),"menuitemcheckbox"===b?B(h):"menuitemradio"===b&&z(h),h.classList.add(f.prefix+"-active"),g.dispatchEvent("select",h.id),setTimeout(function(){h.classList.remove(f.prefix+
"-active")},f.menuActiveDuration),a.stopPropagation(),a.preventDefault())}if(f.hotkey&&f.hotkey.modifiers&&c===f.hotkey.keycode&&a.altKey===f.hotkey.modifiers.a&&a.shiftKey===f.hotkey.modifiers.s&&a.ctrlKey===f.hotkey.modifiers.c&&a.metaKey===f.hotkey.modifiers.m){var l=document.querySelectorAll("."+f.prefix+"-active");for(b=0;b<l.length;b++)l[b].classList.remove(f.prefix+"-active");if(e)k();else if(d.children){d.classList.add(f.prefix+"-focus");for(b=0;b<d.children.length;b++)if(l=d.children[b],
"true"!==l.getAttribute("aria-disabled")){l.classList.add(f.prefix+"-active");p(l,1);e=l;break}p(d.children[0],1);e=d.children[0]}a.stopPropagation();a.preventDefault()}if(d.classList.contains(f.prefix+"-focus"))switch(c){case 13:case 32:case 33:case 34:case 37:case 38:case 39:case 40:S(c);a.stopPropagation();a.preventDefault();break;case 27:k(),a.stopPropagation(),a.preventDefault()}}function R(a){return a.menu===this.menu&&a.key===this.key&&Utils.areEqual(a.modifiers,this.modifiers)}function S(a){function b(a){for(;c&&
("separator"===c.getAttribute("role")||f.skipDisabledItems&&"true"===c.getAttribute("aria-disabled"));)c=a?c.previousElementSibling:c.nextElementSibling;c&&c!==e&&(e.parentNode!==d&&(e.classList.remove(f.prefix+"-active"),g.dispatchEvent("leave",e.id)),c.classList.add(f.prefix+"-active"),g.dispatchEvent("enter",c.id),e=c)}var c,h=0,l,n=d.querySelector("ul.menu-top.menu-focus > li."+f.prefix+"-active");if(n){var m=e.parentNode!==d&&"right"===n.getAttribute("data-align");m&&(37==a?a=39:39==a&&(a=37));
switch(a){case 13:case 32:e&&(0===e.children.length&&"true"!==e.getAttribute("aria-disabled")?(h=e.getAttribute("role"),"menuitemcheckbox"===h?B(e):"menuitemradio"===h&&z(e),g.dispatchEvent("select",e.id),k()):p(e,I(e),!0));break;case 37:if(2<I(e))e.parentNode.className="",H(e),e=e.parentNode.parentNode;else{a=K();c=n;l=a.indexOf(n);do m?++l>=a.length&&(l=0,++h):0>--l&&(l=a.length-1,++h),c=a[l];while(f.skipDisabledItems&&"true"===c.getAttribute("aria-disabled")&&3>h);n!==c&&(H(n),c.classList.add(f.prefix+
"-active"),g.dispatchEvent("enter",c.id),p(c,1),e=c)}break;case 39:if(e.parentNode!==d&&e.children.length)p(e,I(e),!0);else{a=K();c=n;l=a.indexOf(n);do m?0>--l&&(l=a.length-1,++h):++l>=a.length&&(l=0,++h),c=a[l];while(f.skipDisabledItems&&"true"===c.getAttribute("aria-disabled")&&3>h);n!==c&&(H(n),c.classList.add(f.prefix+"-active"),g.dispatchEvent("enter",c.id),p(c,1),e=c)}break;case 38:c=e.parentNode===d&&n.children.length?n.children[0].children[n.children[0].children.length-1]:e.previousElementSibling;
b(!0);break;case 40:e.parentNode===d&&n.children.length?(e.children.length&&!e.children[0].classList.contains(f.prefix+"-open-1")&&p(e,1),c=n.children[0].children[0]):c=e.nextElementSibling;b();break;case 33:if(h=e.parentNode===d?e.children[0]:e.parentNode)c=h.children[0],b();break;case 34:if(h=e.parentNode===d?e.children[0]:e.parentNode)c=h.children[h.children.length-1],b(!0)}}}function K(){for(var a=[],b=0,c=d.children.length;b<c;b++)a.push(d.children[b]);a.sort(function(a,b){return a.offsetLeft-
b.offsetLeft});return a}function Q(a){if(!a)return 0;if(1==a.length)return a.toUpperCase().charCodeAt(0);if(a=/^f(\d+)$/.exec(a))return 111+Number(a[1])}function I(a){for(var b=1;a!==d;)"UL"===a.nodeName&&++b,a=a.parentNode;return b}function B(a){"true"===a.getAttribute("aria-checked")?a.removeAttribute("aria-checked"):a.setAttribute("aria-checked","true")}function z(a){for(var b=a.parentNode.querySelectorAll('li[name="'+a.getAttribute("name")+'"][aria-checked="true"]'),c=0;c<b.length;c++)b[c].removeAttribute("aria-checked");
a.setAttribute("aria-checked","true")}var g=this,t=null,u,d,m={},L,e,v=!1,G=!1,M=!1,q,C,f={prefix:"menu",popupDelay:300,menuActiveDuration:120,hotkey:null,skipDisabledItems:!0,defaultPlaceholder:"No items"};document.documentElement.classList.add(platform.os.family.toLowerCase().replace(/\W+/g,"-"));var P=["icon","align","placeholder","shortcut"],r={show:!1,separator:"",order:"scam",keys:{s:"",c:"",a:"",m:""}};switch(platform.os.family.toLowerCase()){case "windows":case "windows xp":case "windows nt":case "windows server 2008 r2 / 7":case "windows server 2008 r2 / 7 x64":case "windows server 2008 / vista":r=
{show:!0,separator:"+",order:"mcas",keys:{s:"Shift",c:"Ctrl",a:"Alt",m:"Win"}};break;case "os x":r={show:!0,separator:"",order:"casm",keys:{s:"\u21e7",c:"\u2303",a:"\u2325",m:"\u2318"}}}if(D)if(u=document.getElementById(D))if("DIV"!==u.nodeName)console.error("Root menu container element must be a <div>");else if(u.setAttribute("role","navigation"),u.children.length||(q=document.createElement("UL"),u.appendChild(q)),d=u.children[0],"UL"!==d.nodeName)console.error("Root menu container element must contain an <ul>");
else{t=++Menu.nextAvailableId;Utils.merge(f,O);document.attachEvent?document.attachEvent("onkeydown",J):document.addEventListener("keydown",J);d.classList.add(f.prefix+"-top");d.setAttribute("role","menubar");d.style.zIndex+=50-t;for(q=0;q<d.children.length;++q)y(d.children[q]);var N=d.getElementsByTagName("ul");for(q=0;q<N.length;++q){var w=N[q];w.setAttribute("role","menu");"LI"===w.parentNode.nodeName&&w.setAttribute("aria-labelledby",w.parentNode.id);for(C=0;C<w.children.length;++C)y(w.children[C])}u.style.display=
"block";d.addEventListener("mouseover",function(a){clearTimeout(L);if("true"!==a.target.getAttribute("aria-disabled")&&"separator"!==a.target.getAttribute("role")&&d.classList.contains(f.prefix+"-focus")&&"LI"===a.target.nodeName){g.dispatchEvent("enter",a.target.id);e=a.target;for(var b=d.querySelectorAll("."+f.prefix+"-active"),c=0;c<b.length;c++)b[c].classList.remove(f.prefix+"-active");for(var h=1,b=a.target;b!==d;){switch(b.nodeName){case "UL":++h;break;case "LI":b.classList.add(f.prefix+"-active")}b=
b.parentNode}r.show&&a.target.parentNode!==d&&0!==f.popupDelay?L=setTimeout(function(){p(a.target,h)},f.popupDelay):p(a.target,h)}a.stopPropagation()});d.addEventListener("mouseout",function(a){d.classList.contains(f.prefix+"-focus")&&"LI"===a.target.nodeName&&(a.target.children.length||a.target.classList.remove(f.prefix+"-active"),"true"!==a.target.getAttribute("aria-disabled")&&"separator"!==a.target.getAttribute("role")&&g.dispatchEvent("leave",a.target.id));a.stopPropagation()});d.addEventListener("touchstart",
function(a){a.stopPropagation();v=!0;var b=a.target;f.popupDelay=0;if(b===d)k();else if(b.parentNode===d&&k(),"true"!==b.getAttribute("aria-disabled")){var c=!!b.children.length;b.parentNode===d?(d.classList.toggle(f.prefix+"-focus"),b.classList.toggle(f.prefix+"-active"),b.classList.contains(f.prefix+"-active")?(k(d),e=b,g.dispatchEvent("enter",b.id),c||g.dispatchEvent("select",b.id),p(a.target,1),c||setTimeout(function(){k()},f.menuActiveDuration)):(c||g.dispatchEvent("select",b.id),k())):"separator"===
b.getAttribute("role")||c||(a=b.getAttribute("role"),"menuitemcheckbox"===a?B(b):"menuitemradio"===a&&z(b),g.dispatchEvent("select",b.id),k())}});d.addEventListener("click",function(a){a.stopPropagation();a.preventDefault();if(v)v=!1;else{var b=a.target;if(b===d)k();else if("true"!==b.getAttribute("aria-disabled")){var c=!!b.children.length;b.parentNode===d?(M?M=!1:(d.classList.toggle(f.prefix+"-focus"),b.classList.toggle(f.prefix+"-active")),b.classList.contains(f.prefix+"-active")?(k(d),e=b,g.dispatchEvent("enter",
b.id),c||g.dispatchEvent("select",b.id),p(a.target,1),c||setTimeout(function(){k()},f.menuActiveDuration)):(c||g.dispatchEvent("select",b.id),k())):"separator"===b.getAttribute("role")||c||(a=b.getAttribute("role"),"menuitemcheckbox"===a?B(b):"menuitemradio"===a&&z(b),g.dispatchEvent("select",b.id),k())}}});document.addEventListener("click",function(){v?v=!1:k()});document.addEventListener("touchstart",function(){v=!0;k()});g.addEventListener=function(a,b){m[a]=m[a]||[];-1===m[a].indexOf(b)&&m[a].push(b);
return b};g.append=function(a,b){var c;a&&(c=document.getElementById(a));c&&x(c,b,"APPEND")};g.clear=function(a,b){if(a){var c=document.getElementById(a);if(c&&c.children.length){var d=c.children[0];if(b)c.removeChild(d);else{for(;d.firstChild;)d.removeChild(d.firstChild);d.appendChild(E(c.getAttribute("data-placeholder")))}y(c)}}};g.dispatchEvent=function(a,b){var c;try{c=new CustomEvent(a,{detail:b})}catch(d){c=document.createEvent("CustomEvent"),c.initCustomEvent(a,!1,!1,b)}if("undefined"!==typeof m[c.type])for(var e=
0;e<m[c.type].length;e++)m[c.type][e].call(this,c)};g.get=function(a){var b=document.getElementById(a);if(!b)return{};a={align:b.getAttribute("data-align")||"left",className:b.className,disabled:"true"===b.getAttribute("aria-disabled")||!1,icon:b.getAttribute("data-icon")||"",id:a,menu:t,placeholder:b.getAttribute("data-placeholder")||f.defaultPlaceholder,shortcut:b.getAttribute("data-shortcut")||"",role:b.getAttribute("role")||"menuitem"};if("menuitemcheckbox"===a.role||"menuitemradio"===a.role)a.checked=
"true"===b.getAttribute("aria-checked")||!1;"menuitemradio"===a.role&&(a.name=b.getAttribute("name")||"");return a};g.getGroupChecked=function(a){return(a=d.querySelector('li[name="'+a+'"][aria-checked="true"]'))?a.id:null};g.insertAfter=function(a,b){var c,e;a?c=document.getElementById(a):d.children.length?c=d.children[d.children.length-1]:(e=document.createElement("li"),d.appendChild(e),c=e);c&&(x(c,b),e&&d.removeChild(e))};g.insertBefore=function(a,b){var c,e;a?c=document.getElementById(a):d.children.length?
c=d.children[0]:(e=document.createElement("li"),d.appendChild(e),c=e);c&&(x(c,b,"BEFORE"),e&&d.removeChild(e))};g.prepend=function(a,b){var c;a&&(c=document.getElementById(a));c&&x(c,b,"PREPEND")};g.remove=function(a){(a=document.getElementById(a))&&a.parentNode.removeChild(a)};g.removeEventListener=function(a,b){if("undefined"!==typeof m[a]){var c=m[a].indexOf(b);-1!==c&&m[a].splice(c,1)}};g.replace=function(a,b){g.clear(a);g.append(a,b)};g.set=function(a,b){var c=document.getElementById(a);c&&"object"===
typeof b&&(Object.keys(b).forEach(function(a){switch(a){case "text":c.textContent=b.text;break;case "className":c.classList.add(b.className);break;case "disabled":b.disabled?c.setAttribute("aria-disabled","true"):c.removeAttribute("aria-disabled");break;case "role":case "name":c.setAttribute(a,b[a]);break;case "checked":a=c.getAttribute("role");b.checked?"menuitemcheckbox"===a?c.setAttribute("aria-checked","true"):"menuitemradio"===a&&z(c):c.removeAttribute("aria-checked");break;case "align":case "icon":case "placeholder":case "shortcut":c.setAttribute("data-"+
a,b[a])}}),y(c))};F.iNextId=0;g.addEventListener("opened",function(a){if((a=document.getElementById(a.detail))&&"LI"===a.nodeName&&a.children.length){for(var b=!1,c=a;c;){if("LI"===c.nodeName&&"right"===c.getAttribute("data-align")){b=!0;break}c=c.parentNode}2<A(a)&&(a.children[0].style.left=(b?"-"+(a.children[0].clientWidth-4):a.clientWidth-4)+"px")}})}else console.error("Cannot find root menu container with id "+D);else console.error("Missing menu id")};
